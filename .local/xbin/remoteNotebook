#!/usr/bin/env zsh
# choose the server to login

# Initialization

# Ensure menu launcher is available
command -v rofi >/dev/null 2>&1 || exit

# Which server to choose
chosen=$(grep -v "#" $HOME/.local/xshare/server.info | awk '{print $1}'| rofi -dmenu -i -p 'choose the ssh server' -lines 20)
[ "$chosen" != "" ] || exit

info=$(grep "$chosen" $HOME/.local/xshare/server.info)
s=$(echo "$info" | awk '{print $2}')
p=$(echo "$info" | awk '{print $3}')

[ "$p" != "" ] || exit

# Connet to remote Jupyter server
# input is the $(which jupyter) on server

port1="$p"

SOCK="$XDG_RUNTIME_DIR/ssh-agent.socket"
export SSH_AUTH_SOCK="$SOCK"

# Read remote jupyter info (now ssh sees SSH_AUTH_SOCK)
info_remote=$(ssh "$s" 'cat "$HOME/.cache/jupyterlab.info"')
client=$(awk '{print $1}' <<< "$info_remote")
port3=$(awk '{print $2}' <<< "$info_remote")

port1="$p"

# kill existing local listeners on port1
pids=$(lsof -i :"$port1" 2>/dev/null | awk '/LISTEN/ {print $2}' | sort -u)
if [ -n "$pids" ]; then
  kill $pids
fi

# Set up tunnel (also uses SSH_AUTH_SOCK)
cmd=(ssh -f -N -L "${port1}:${client}:${port3}" "$s")
echo "${cmd[@]}"
"${cmd[@]}"

url="http://localhost:${port1}"
echo "URL that will open in your browser:"
echo "$url"

brave "$url"
